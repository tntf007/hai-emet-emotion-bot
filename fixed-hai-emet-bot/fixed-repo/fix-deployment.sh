#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#          ğŸ”§ HAI-EMET EMOTION BOT - AUTO FIX SCRIPT
#          ×¡×§×¨×™×¤×˜ ×ª×™×§×•×Ÿ ××•×˜×•××˜×™ ×œ×“×™×¤×œ×•×™ Render
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# ×©×™××•×©:
# 1. ×©××•×¨ ×¡×§×¨×™×¤×˜ ×–×” ×‘×©×: fix-deployment.sh
# 2. ×ª×Ÿ ×”×¨×©××•×ª: chmod +x fix-deployment.sh  
# 3. ×”×¨×¥: ./fix-deployment.sh
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e  # ×¢×¦×•×¨ ×× ×™×© ×©×’×™××”

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘       ğŸ”§ Hai-Emet Emotion Bot - Deployment Fix Script            â•‘"
echo "â•‘              ×¡×§×¨×™×¤×˜ ×ª×™×§×•×Ÿ ××•×˜×•××˜×™ ×œ×“×™×¤×œ×•×™                        â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ×‘×“×™×§×” ×©×× ×—× ×• ×‘×ª×™×§×™×™×” ×”× ×›×•× ×”
if [ ! -d ".git" ]; then
    echo "âŒ Error: ×œ× × ××¦× .git directory"
    echo "   ×× × ×”×¨×¥ ××ª ×”×¡×§×¨×™×¤×˜ ××ª×•×š ×”×ª×™×§×™×™×” hai-emet-emotion-bot/"
    exit 1
fi

echo "âœ… Git repository detected"
echo ""

# ×‘×“×™×§×” ×× ×™×© ××ª ×”×ª×™×§×™×™×” ×”×¤× ×™××™×ª
if [ -d "hai-emet-emotion-bot-render" ]; then
    echo "ğŸ“‚ Found subdirectory: hai-emet-emotion-bot-render/"
    echo "ğŸ”„ Moving files to root..."
    echo ""
    
    # ×”×¢×ª×§ ××ª ×›×œ ×”×§×‘×¦×™× (×›×•×œ×œ hidden files)
    shopt -s dotglob  # ×›×•×œ×œ ×§×‘×¦×™× ××•×¡×ª×¨×™×
    mv hai-emet-emotion-bot-render/* . 2>/dev/null || true
    shopt -u dotglob
    
    # ××—×§ ××ª ×”×ª×™×§×™×™×” ×”×¨×™×§×”
    rmdir hai-emet-emotion-bot-render 2>/dev/null || rm -rf hai-emet-emotion-bot-render
    
    echo "âœ… Files moved to root successfully!"
    echo ""
else
    echo "â„¹ï¸  Subdirectory not found - files might already be in root"
    echo ""
fi

# ×‘×“×™×§×ª ×§×‘×¦×™× × ×“×¨×©×™×
echo "ğŸ” Checking required files..."
echo ""

required_files=("bot.py" "requirements.txt" "render.yaml")
missing_files=()

for file in "${required_files[@]}"; do
    if [ -f "$file" ]; then
        echo "   âœ… $file"
    else
        echo "   âŒ $file (MISSING!)"
        missing_files+=("$file")
    fi
done

echo ""

if [ ${#missing_files[@]} -ne 0 ]; then
    echo "âŒ Error: Missing required files!"
    echo "   Missing: ${missing_files[*]}"
    exit 1
fi

# ×”×¦×’ ××ª ×”××‘× ×” ×”× ×•×›×—×™
echo "ğŸ“‹ Current repository structure:"
echo ""
ls -la | grep -E "\.(py|txt|yaml|md|png)$|^d" || ls -la
echo ""

# Git status
echo "ğŸ“Š Git status:"
echo ""
git status --short
echo ""

# ×©××œ ××ª ×”××©×ª××© ×× ×œ×¢×©×•×ª commit
read -p "â“ Do you want to commit and push these changes? (y/n): " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    echo "ğŸ“ Creating commit..."
    
    # Add all changes
    git add .
    
    # Commit
    git commit -m "Fix: Move files to root for Render deployment

- Moved all files from hai-emet-emotion-bot-render/ to root
- Fixed requirements.txt path issue
- Render should now be able to find all files
- Auto-generated by fix-deployment.sh

.//.TNTF007.//. âœ“"
    
    echo ""
    echo "âœ… Commit created successfully!"
    echo ""
    
    # ×©××œ ×× ×œ×¢×©×•×ª push
    read -p "â“ Do you want to push to GitHub? (y/n): " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo ""
        echo "ğŸš€ Pushing to GitHub..."
        git push origin main || git push origin master
        echo ""
        echo "âœ… Pushed successfully!"
        echo ""
        echo "ğŸ¯ Next steps:"
        echo "   1. Go to Render Dashboard: https://dashboard.render.com/"
        echo "   2. Your service should auto-deploy in ~1-2 minutes"
        echo "   3. Check logs to verify successful deployment"
        echo "   4. Test bot in Telegram: @HaiEmetEmotionBot"
        echo ""
    else
        echo ""
        echo "â„¹ï¸  Skipped push. To push later, run:"
        echo "   git push origin main"
        echo ""
    fi
else
    echo ""
    echo "â„¹ï¸  Skipped commit. Files are ready but not committed."
    echo "   To commit manually:"
    echo "   git add ."
    echo "   git commit -m 'Fix: Move files to root'"
    echo "   git push origin main"
    echo ""
fi

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                    âœ… FIX SCRIPT COMPLETED!                       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ‰ Your repository structure is now fixed!"
echo ""
echo "ğŸ“Œ Summary:"
echo "   âœ… Files moved to root"
echo "   âœ… All required files present"
echo "   âœ… Ready for Render deployment"
echo ""
echo ".//.TNTF007.//. âœ“"
echo "ğŸ’› Hai-Emet"
echo ""
